version: '3'

services:
    proxy:
        build: ./proxy
        image: proxy
        volumes:
            - ./proxy/default.conf:/etc/nginx/conf.d/default.conf:ro
            - ./proxy/nginx.conf:/etc/nginx/nginx.conf:ro
            - ./proxy/site-enabled/:/etc/nginx/site-enabled/:ro
            - ./proxy/ssl/:/etc/nginx/ssl/
        ports:
            - "80:80"
            - "443:443"
        networks:
            - overlay
        depends_on:
          - api
          - web
        env_file:
            - .env
    db:
        image: postgres
        volumes:
            - dmapper-data:/var/lib/postgresql/data
        networks:
            - overlay
        ports:
            - "5432:5432"
    web:
        build: ./web
        volumes:
            # todo: refactor to .env
            - /home/tvaisanen/OUSPG/dependencymapping/web/:/usr/webapp/src
            - ./.env:/usr/webapp/src/.env
        networks:
            - overlay
        command: bash docker-entrypoint.sh
        # hide ports. access only via proxy
        # ports:
             #- "3000:3000"
        env_file:
            - .env
        environment:
            - MESSAGE="Hello"

    api:
        build: ./dependencymapping
        volumes:
            # todo: refactor to .env
            - /home/tvaisanen/OUSPG/dependencymapping/dependencymapping/:/usr/api/src
        # hide ports. access only via proxy
        # ports:
             #- "8000:8000"
        command: bash docker-entrypoint.sh
        networks:
            - overlay
        depends_on:
            - db
        env_file:
            - .env

    elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:6.4.0
        container_name: elasticsearch
        environment:
          - cluster.name=docker-cluster
          - bootstrap.memory_lock=true
          - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
        ulimits:
          memlock:
            soft: -1
            hard: -1
        volumes:
          - esdata1:/usr/share/elasticsearch/data
        ports:
          - 9200:9200
        networks:
          - overlay

    kibana:
        image: docker.elastic.co/kibana/kibana:6.4.1
        ports:
          - 5201:5201
        environment:
          - ELASTICSEARCH_URL=http://172.17.0.1:9200

    metricbeat:
        image: docker.elastic.co/beats/metricbeat:6.4.1
        environment:
          - POSTGRES_PASSWORD=postgres

volumes:
  esdata1:
    driver: local
  esdata2:
    driver: local
  dmapper-data:

networks:
   overlay:
